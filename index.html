<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Next Shipment Updater</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      padding: 16px;
      margin: 0;
      background: #f5f5f5;
    }
    
    .container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    h2 {
      margin: 0 0 16px 0;
      font-size: 18px;
      font-weight: 600;
      color: #333;
      border-bottom: 2px solid #16c79a;
      padding-bottom: 8px;
    }
    
    .info-box {
      padding: 12px;
      background: #e3f2fd;
      border-radius: 4px;
      border-left: 4px solid #2196f3;
      margin-bottom: 16px;
      font-size: 13px;
      line-height: 1.5;
    }
    
    .shipment-display {
      padding: 16px;
      background: #f8f9fa;
      border-radius: 4px;
      margin-bottom: 16px;
    }
    
    .label {
      font-size: 12px;
      font-weight: 500;
      color: #666;
      text-transform: uppercase;
      margin-bottom: 4px;
    }
    
    .value {
      font-size: 20px;
      font-weight: 600;
      color: #16c79a;
    }
    
    .status {
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 13px;
      margin-bottom: 12px;
      text-align: center;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .status.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .auto-update {
      font-size: 12px;
      color: #666;
      text-align: center;
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ðŸ“¦ Active Shipment Tracker</h2>
    
    <div class="info-box">
      <strong>Purpose:</strong> This widget automatically tracks which shipment you select. 
      Your samples can then reference this "active" shipment using trigger formulas.
      <div id="user-display" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #b3d9ff; font-size: 12px;">
        <strong>ðŸ‘¤ Current User:</strong> <span id="user-name">Loading...</span>
      </div>
    </div>
    
    <div id="status-area">
      <div class="status info">Waiting for shipment selection...</div>
    </div>
    
    <div class="shipment-display" id="shipment-display" style="display: none;">
      <div class="label">ðŸ“¥ Received from Selection</div>
      <div class="value" id="shipment-value">-</div>
      <div id="shipment-details" style="margin-top: 8px; font-size: 13px; color: #666;"></div>
    </div>
    
    <div class="shipment-display" id="nexttable-display" style="display: none; border: 2px solid #16c79a;">
      <div class="label">ðŸ“Œ Current Value in Next_Shipment Table</div>
      <div class="value" style="color: #0d8c6c;" id="nexttable-value">-</div>
      <div id="nexttable-details" style="margin-top: 8px; font-size: 13px; color: #666;"></div>
    </div>
    
    <div class="auto-update">
      âš¡ Updates automatically when you select a different shipment
    </div>
    
    <div style="text-align: center; margin-top: 12px;">
      <button onclick="manualRefresh()" style="padding: 6px 12px; font-size: 12px; cursor: pointer; background: #e0e0e0; border: 1px solid #ccc; border-radius: 4px;">
        ðŸ”„ Manual Refresh
      </button>
    </div>
  </div>

  <script>
    let nextShipmentTableId = 'Next_Shipment';  // Adjust if your table name differs
    let lastProcessedId = null;  // Track last processed shipment to avoid duplicates
    let currentUser = null;  // Store current user info
    
    grist.ready({
      requiredAccess: 'full',
      onEditOptions: true  // Enable configuration
    });
    
    // Get current user information
    async function getCurrentUser() {
      try {
        // Try multiple methods to get user info
        
        // Method 1: Get from table access (most reliable for logged-in users)
        const tables = await grist.docApi.listTables();
        console.log('Available tables:', tables);
        
        // Method 2: Use the user context from Grist
        // The $User variable in formulas corresponds to user.Email attribute
        const usersTable = await grist.docApi.fetchTable('_grist_Users');
        console.log('Users table:', usersTable);
        
        // Try to get current user's email directly
        // In Grist, we can access this through the doc metadata
        let userEmail = null;
        let userName = null;
        
        // Check if there's user info in the users table
        if (usersTable && usersTable.Email && usersTable.Email.length > 0) {
          // The last user in the list is often the current user, but this isn't reliable
          // Better approach: use grist.getUser()
          const user = await grist.getUser();
          console.log('Current user from grist.getUser():', user);
          
          if (user && user.Email) {
            userEmail = user.Email;
            userName = user.Name || user.Email.split('@')[0];
          }
        }
        
        // Fallback if we still don't have user info
        if (!userEmail) {
          throw new Error('Could not determine user email');
        }
        
        return {
          email: userEmail,
          name: userName,
          id: userEmail  // Use email as ID since it's unique
        };
      } catch (error) {
        console.error('Could not fetch user info:', error);
        throw new Error('This widget requires a logged-in Grist user. Session-based users are not supported.');
      }
    }
    
    // Initialize user context
    (async () => {
      try {
        currentUser = await getCurrentUser();
        console.log('Current user:', currentUser);
        updateUserDisplay();
      } catch (error) {
        console.error('Failed to initialize user:', error);
        showStatus('Error: ' + error.message, 'warning');
        // Show error in UI
        document.getElementById('user-name').textContent = 'Error: ' + error.message;
        document.getElementById('user-name').style.color = '#dc3545';
      }
    })();
    
    // Configure table name via widget options if needed
    grist.onOptions(function(options) {
      console.log('Widget options received:', options);
      if (options.nextShipmentTable) {
        nextShipmentTableId = options.nextShipmentTable;
      }
    });
    
    // Handle single record selection (when widget shows SELECT BY)
    grist.onRecord(async function(record, mappings) {
      console.log('onRecord called with:', record, 'mappings:', mappings);
      await handleShipmentSelection(record);
    });
    
    // Handle when widget shows multiple records (failsafe)
    grist.onRecords(async function(records, mappings) {
      console.log('onRecords called with:', records, 'mappings:', mappings);
      // Take the first record if available
      if (records && records.length > 0) {
        await handleShipmentSelection(records[0]);
      }
    });
    
    // Unified handler for shipment selection
    async function handleShipmentSelection(record) {
      console.log('Processing shipment record:', record);
      
      if (!record || !record.id) {
        console.log('No valid record received');
        showStatus('No shipment selected', 'info');
        hideShipmentDisplay();
        lastProcessedId = null;
        return;
      }
      
      // Only skip if it's the exact same ID AND we just processed it (within 100ms)
      const now = Date.now();
      if (lastProcessedId === record.id && (now - (window.lastProcessTime || 0)) < 100) {
        console.log('Skipping duplicate call for shipment ID:', record.id);
        return;
      }
      
      lastProcessedId = record.id;
      window.lastProcessTime = now;
      console.log('Processing shipment ID:', record.id, 'at', new Date(now).toISOString());
      
      // First show what we received
      showShipmentDisplay(record);
      showStatus('â³ Updating Next_Shipment table...', 'info');
      
      // Update the Next_Shipment table with this shipment's ID
      try {
        await updateNextShipment(record);
        showStatus('âœ“ Active shipment updated successfully!', 'success');
        
        // Clear success message after 3 seconds
        setTimeout(() => {
          document.getElementById('status-area').innerHTML = '';
        }, 3000);
        
      } catch (error) {
        console.error('Error updating Next_Shipment:', error);
        showStatus('âŒ Error: ' + error.message, 'warning');
      }
    }
    
    // Load initial Next_Shipment value on startup
    setTimeout(async () => {
      await displayNextShipmentValue();
    }, 500);
    
    async function updateNextShipment(shipmentRecord) {
      if (!currentUser) {
        console.error('User not initialized yet');
        await new Promise(resolve => setTimeout(resolve, 500));
        currentUser = await getCurrentUser();
      }
      
      try {
        const nextShipmentData = await grist.docApi.fetchTable(nextShipmentTableId);
        const userColumn = nextShipmentData.User || nextShipmentData.user_email || [];
        
        // Find existing row for this user
        let userRowId = null;
        for (let i = 0; i < nextShipmentData.id.length; i++) {
          if (userColumn[i] === currentUser.email || userColumn[i] === currentUser.id) {
            userRowId = nextShipmentData.id[i];
            break;
          }
        }
        
        if (userRowId) {
          // Update existing row
          await grist.docApi.applyUserActions([
            ['UpdateRecord', nextShipmentTableId, userRowId, {
              Shipment: shipmentRecord.id,
              User: currentUser.email
            }]
          ]);
          console.log('Updated Next_Shipment row', userRowId, 'for user', currentUser.email);
        } else {
          // Create new row for this user
          await grist.docApi.applyUserActions([
            ['AddRecord', nextShipmentTableId, null, {
              Shipment: shipmentRecord.id,
              User: currentUser.email
            }]
          ]);
          console.log('Created new Next_Shipment row for user', currentUser.email);
        }
      } catch (error) {
        console.error('Error updating Next_Shipment:', error);
        throw error;
      }
      
      // Fetch and display the updated value from Next_Shipment table
      await displayNextShipmentValue();
    }
    
    async function displayNextShipmentValue() {
      try {
        // Fetch the Next_Shipment table data
        const nextShipmentData = await grist.docApi.fetchTable(nextShipmentTableId);
        console.log('Next_Shipment table data:', nextShipmentData);
        
        if (!currentUser) {
          console.warn('User not initialized yet');
          return;
        }
        
        // Find this user's row
        const userColumn = nextShipmentData.User || nextShipmentData.user_email || [];
        let rowIndex = -1;
        
        for (let i = 0; i < nextShipmentData.id.length; i++) {
          if (userColumn[i] === currentUser.email || userColumn[i] === currentUser.id) {
            rowIndex = i;
            break;
          }
        }
        
        if (rowIndex === -1) {
          console.warn('Could not find Next_Shipment row for user:', currentUser.email);
          document.getElementById('nexttable-value').textContent = 'No row found';
          document.getElementById('nexttable-details').innerHTML = 'No row for current user yet - select a shipment to create one';
          document.getElementById('nexttable-display').style.display = 'block';
          return;
        }
        
        // Get the Shipment reference value
        const shipmentRefId = nextShipmentData.Shipment ? nextShipmentData.Shipment[rowIndex] : null;
        
        const display = document.getElementById('nexttable-display');
        const value = document.getElementById('nexttable-value');
        const details = document.getElementById('nexttable-details');
        
        if (shipmentRefId) {
          // Fetch the actual shipment record to show details
          try {
            const shipmentsData = await grist.docApi.fetchTable('Shipments');
            const shipmentIndex = shipmentsData.id.indexOf(shipmentRefId);
            
            if (shipmentIndex !== -1) {
              const displayId = (shipmentsData.Shipment_ID && shipmentsData.Shipment_ID[shipmentIndex]) || 
                              (shipmentsData.shipment_id && shipmentsData.shipment_id[shipmentIndex]) || 
                              `Shipment #${shipmentRefId}`;
              
              value.textContent = displayId;
              
              let detailsHtml = `<strong>Reference ID:</strong> ${shipmentRefId}`;
              
              if (shipmentsData.Date && shipmentsData.Date[shipmentIndex]) {
                detailsHtml += ` | <strong>Date:</strong> ${shipmentsData.Date[shipmentIndex]}`;
              }
              if (shipmentsData.Destination && shipmentsData.Destination[shipmentIndex]) {
                detailsHtml += ` | <strong>Destination:</strong> ${shipmentsData.Destination[shipmentIndex]}`;
              }
              
              details.innerHTML = detailsHtml;
            } else {
              value.textContent = `Shipment ID: ${shipmentRefId}`;
              details.innerHTML = '<strong>Reference ID:</strong> ' + shipmentRefId;
            }
          } catch (err) {
            console.error('Error fetching shipment details:', err);
            value.textContent = `Shipment ID: ${shipmentRefId}`;
            details.innerHTML = '<strong>Reference ID:</strong> ' + shipmentRefId;
          }
        } else {
          value.textContent = 'None (empty)';
          details.innerHTML = 'No shipment is currently set';
        }
        
        display.style.display = 'block';
        
      } catch (error) {
        console.error('Error fetching Next_Shipment value:', error);
        document.getElementById('nexttable-value').textContent = 'Error loading';
        document.getElementById('nexttable-details').innerHTML = error.message;
      }
    }
    
    // Update user display in UI
    function updateUserDisplay() {
      if (currentUser) {
        const userNameEl = document.getElementById('user-name');
        userNameEl.textContent = currentUser.name || currentUser.email;
      }
    }
    function showShipmentDisplay(record) {
      const display = document.getElementById('shipment-display');
      const value = document.getElementById('shipment-value');
      const details = document.getElementById('shipment-details');
      
      // Try to get a display value from common column names
      const displayId = record.Shipment_ID || 
                       record.shipment_id || 
                       record.name || 
                       record.Name ||
                       `Shipment #${record.id}`;
      
      value.textContent = displayId;
      
      // Show additional details if available
      let detailsHtml = `<strong>Row ID:</strong> ${record.id}`;
      
      if (record.Date || record.date) {
        detailsHtml += ` | <strong>Date:</strong> ${record.Date || record.date}`;
      }
      if (record.Destination || record.destination) {
        detailsHtml += ` | <strong>Destination:</strong> ${record.Destination || record.destination}`;
      }
      
      details.innerHTML = detailsHtml;
      display.style.display = 'block';
    }
    
    function hideShipmentDisplay() {
      document.getElementById('shipment-display').style.display = 'none';
    }
    
    function showStatus(message, type) {
      const statusArea = document.getElementById('status-area');
      statusArea.innerHTML = `<div class="status ${type}">${message}</div>`;
    }
    
    // Manual refresh function for troubleshooting
    async function manualRefresh() {
      console.log('Manual refresh triggered');
      showStatus('â³ Refreshing...', 'info');
      await displayNextShipmentValue();
      showStatus('âœ“ Refreshed', 'success');
      setTimeout(() => {
        document.getElementById('status-area').innerHTML = '';
      }, 2000);
    }
  </script>
</body>
</html>
  
    // Update user display in UI
    function updateUserDisplay() {
      if (currentUser) {
        const userNameEl = document.getElementById('user-name');
        userNameEl.textContent = currentUser.name || currentUser.email;
        if (multiUserMode) {
          userNameEl.textContent += ' (Multi-user mode)';
          userNameEl.style.color = '#16c79a';
          userNameEl.style.fontWeight = 'bold';
        }
      }
    }
  